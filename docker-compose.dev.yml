version: "3.8"

services:
  # ------------------------------------------------------------------------
  # 1. Database for Auth-Service (Security)
  # ------------------------------------------------------------------------
  db-security:
    image: postgres:15-alpine
    container_name: bball_db_security
    environment:
      POSTGRES_DB: ${DB_SECURITY_NAME}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD} # <--- Uses .env
    volumes:
      - postgres_security_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U LeDB -d \"$$POSTGRES_DB\""]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  # ------------------------------------------------------------------------
  # 2. Database for Stats-Service
  # ------------------------------------------------------------------------
  db-stats:
    image: postgres:15-alpine
    container_name: bball_db_stats
    environment:
      POSTGRES_DB: ${DB_STATS_NAME}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD} # <--- Uses .env
    volumes:
      - postgres_stats_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U LeDB -d \"$$POSTGRES_DB\""]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  # ------------------------------------------------------------------------
  # 2b. Database for Prediction-Service
  # ------------------------------------------------------------------------
  db-prediction:
    image: postgres:15-alpine
    container_name: bball_db_prediction
    environment:
      POSTGRES_DB: ${DB_PREDICTION_NAME}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD} # <--- Uses .env
    volumes:
      - postgres_prediction_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U LeDB -d \"$$POSTGRES_DB\""]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  # ------------------------------------------------------------------------
  # 3. Eureka Server (Service Discovery)
  # ------------------------------------------------------------------------
  eureka-server:
    build:
      context: ./eureka-server
      args:
        # Reference the JAR file you just built
        - JAR_FILE=target/eureka-server-0.0.1-SNAPSHOT.jar
    container_name: bball_eureka_server
    expose:
      - "8761" # Expose Eureka dashboard
    environment:
      # Use service name for inter-container communication
      EUREKA_INSTANCE_HOSTNAME: eureka-server
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
    depends_on:
      db-security:
        condition: service_healthy
      db-stats:
        condition: service_healthy
      db-prediction:
        condition: service_healthy
    restart: always

  # ------------------------------------------------------------------------
  # 4. Security Service (Auth-Service)
  # ------------------------------------------------------------------------
  security-service:
    build:
      context: ./security
      args:
        - JAR_FILE=target/security-0.0.1-SNAPSHOT.jar
    container_name: bball_security_service
    expose:
      - "8082" # Expose Security API endpoint
    environment:
      # Link DB and Eureka using container service names
      SPRING_DATASOURCE_URL: jdbc:postgresql://db-security:5432/${DB_SECURITY_NAME}
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      APPLICATION_SECURITY_JWT_SECRET_KEY: ${JWT_SECRET} # <--- CRITICAL
      APPLICATION_SECURITY_JWT_EXPIRATION: ${JWT_EXPIRATION}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: "true"
    depends_on:
      db-security:
        condition: service_healthy
      eureka-server:
        condition: service_started
    restart: always

  # ------------------------------------------------------------------------
  # 5. Stats Service
  # ------------------------------------------------------------------------
  stats-service:
    build:
      context: ./stats
      args:
        - JAR_FILE=target/stats-0.0.1-SNAPSHOT.jar
    container_name: bball_stats_service
    expose:
      - "8081" # Expose Stats API endpoint
    environment:
      # Link DB and Eureka using container service names
      SPRING_DATASOURCE_URL: jdbc:postgresql://db-stats:5432/${DB_STATS_NAME}
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      NBA_API_BASE_URL: http://nba-fetcher:5001
      SPRING_DATA_REDIS_HOST: redis # Matches the service name 'redis' below
      SPRING_DATA_REDIS_PORT: 6379
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: "true"
    depends_on:
      db-stats:
        condition: service_healthy
      eureka-server:
        condition: service_started
      security-service:
        condition: service_started
      redis:
        condition: service_started
    restart: always

  # ------------------------------------------------------------------------
  # 6. NBA Fetcher (Python Sidecar) - NEW!
  # ------------------------------------------------------------------------
  nba-fetcher:
    build:
      context: ./nba-fetcher
    container_name: bball_nba_fetcher
    expose:
      - "5001" # Expose port 5001
    environment:
      # Add this line so the Python script can find the Eureka server
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
    networks:
      - default
    restart: always

  redis:
    image: redis:alpine
    container_name: bball_redis
    #    ports:
    #      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: always

  # ------------------------------------------------------------------------
  # 7. Prediction Service (PyTorch Neural Network)
  # ------------------------------------------------------------------------
  prediction:
    build:
      context: ./prediction
    container_name: bball_prediction
    expose:
      - "5002"
    environment:
      PYTHONUNBUFFERED: 1
      REDIS_HOST: redis
      REDIS_PORT: 6379
      DATABASE_URL: postgresql://${DB_USERNAME}:${DB_PASSWORD}@db-prediction:5432/${DB_PREDICTION_NAME}
      STATS_SERVICE_URL: http://stats-service:8081
    depends_on:
      db-prediction:
        condition: service_healthy
      redis:
        condition: service_started
      eureka-server:
        condition: service_started
      stats-service:
        condition: service_started
    networks:
      - default
    restart: always

  # ------------------------------------------------------------------------
  # 8. API Gateway
  # ------------------------------------------------------------------------
  api-gateway:
    build:
      context: ./api-gateway
    container_name: bball_gateway
    ports:
      - "8080:8080" # Expose ONLY this port to the world
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
    depends_on:
      eureka-server:
        condition: service_started
    restart: always

  # 1. Zipkin (Distributed Tracing) - COMMENTED OUT FOR NOW
  # zipkin:
  #   image: openzipkin/zipkin
  #   container_name: bball_zipkin
  #   ports:
  #     - "9411:9411"
  #   networks:
  #     - default
  #   restart: always

  # 2. Prometheus (Metrics Collection) - COMMENTED OUT FOR NOW
  # prometheus:
  #   image: prom/prometheus
  #   container_name: bball_prometheus
  #   expose:
  #     - "9090"
  #   volumes:
  #     - ./prometheus.yml:/etc/prometheus/prometheus.yml
  #   networks:
  #     - default
  #   restart: always

  # 3. Grafana (Dashboard) - COMMENTED OUT FOR NOW
  # grafana:
  #   image: grafana/grafana
  #   container_name: bball_grafana
  #   ports:
  #     - "3000:3000"
  #   environment:
  #     - GF_SECURITY_ADMIN_PASSWORD=password # Login with admin/password
  #   depends_on:
  #     - prometheus
  #     - zipkin
  #   networks:
  #     - default
  #   restart: always

  frontend:
    build:
      context: ./frontend
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    container_name: bball_frontend
    ports:
      - "3001:3000"
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    depends_on:
      - api-gateway
    restart: always
volumes:
  postgres_security_data:
  postgres_stats_data:
  postgres_prediction_data:
  redis_data:
